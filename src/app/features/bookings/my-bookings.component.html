<div class="bookings-container">
  <app-page-header
    title="Mis Reservas"
    subtitle="Gestiona todas tus reservas en un solo lugar"
    icon="pi-calendar"
  >
    <p-button
      label="Nueva Reserva"
      icon="pi pi-plus"
      (onClick)="createBooking()"
      size="large"
      styleClass="new-booking-btn"
    />
  </app-page-header>

  @if (loading()) {
    <div class="loading-container">
      <p-progressSpinner />
      <p>Cargando reservas...</p>
    </div>
  } @else {
    @if (bookings().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <h3>No tienes reservas</h3>
        <p>Crea tu primera reserva para empezar</p>
        <p-button
          label="Crear Reserva"
          icon="pi pi-plus"
          (onClick)="createBooking()"
        />
      </div>
    } @else {
      <div class="bookings-grid">
        @for (booking of bookings(); track booking.id) {
          <div class="booking-card">
            <div class="card-header">
              <div class="space-name">
                <i class="pi pi-building"></i>
                <h3>{{ booking.space?.name || 'N/A' }}</h3>
              </div>
              <p-tag
                [value]="getStatusLabel(booking.status)"
                [severity]="getStatusSeverity(booking.status)"
              />
            </div>

            <div class="card-body">
              <div class="event-title">
                <i class="pi pi-bookmark"></i>
                <strong>{{ booking.event_title }}</strong>
              </div>

              <div class="booking-details">
                <div class="detail-item">
                  <i class="pi pi-calendar"></i>
                  <div class="detail-content">
                    <span class="label">Inicio</span>
                    <span class="value">{{ booking.start_time | date : 'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                </div>

                <div class="detail-item">
                  <i class="pi pi-calendar-times"></i>
                  <div class="detail-content">
                    <span class="label">Fin</span>
                    <span class="value">{{ booking.end_time | date : 'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                </div>

                <div class="detail-item">
                  <i class="pi pi-users"></i>
                  <div class="detail-content">
                    <span class="label">Asistentes</span>
                    <span class="value">{{ booking.attendees_count }} personas</span>
                  </div>
                </div>

                @if (booking.event_description) {
                  <div class="detail-item full-width">
                    <i class="pi pi-info-circle"></i>
                    <div class="detail-content">
                      <span class="label">Descripción</span>
                      <span class="value description">{{ booking.event_description }}</span>
                    </div>
                  </div>
                }
              </div>
            </div>

            <div class="card-footer">
              @if (showReviewForm[booking.id]) {
                <div class="review-form-inline">
                  <div class="form-header">
                    <h4>
                      <i class="pi pi-star"></i>
                      Califica tu experiencia
                    </h4>
                    <p-button
                      icon="pi pi-times"
                      [text]="true"
                      [rounded]="true"
                      size="small"
                      (onClick)="toggleReviewForm(booking.id)"
                    />
                  </div>

                  <div class="rating-input">
                    <label>Tu calificación *</label>
                    <p-rating
                      [(ngModel)]="reviewRatings[booking.id]"
                      [cancel]="false"
                      [stars]="5"
                    />
                  </div>

                  <div class="comment-input">
                    <label for="review-{{booking.id}}">Cuéntanos sobre tu experiencia</label>
                    <textarea
                      pInputTextarea
                      id="review-{{booking.id}}"
                      [(ngModel)]="reviewComments[booking.id]"
                      rows="4"
                      placeholder="Comparte tu opinión sobre este espacio..."
                    ></textarea>
                  </div>

                  <div class="form-actions">
                    <p-button
                      label="Cancelar"
                      severity="secondary"
                      [outlined]="true"
                      size="small"
                      (onClick)="toggleReviewForm(booking.id)"
                    />
                    <p-button
                      label="Enviar Reseña"
                      icon="pi pi-check"
                      severity="success"
                      size="small"
                      (onClick)="submitReview(booking)"
                    />
                  </div>
                </div>
              } @else {
                <div class="action-buttons">
                  @if (booking.status === 'pending' || booking.status === 'confirmed') {
                    <p-button
                      label="Editar"
                      icon="pi pi-pencil"
                      severity="info"
                      [outlined]="true"
                      size="small"
                      (onClick)="editBooking(booking.id)"
                    />
                    <p-button
                      label="Cancelar Reserva"
                      icon="pi pi-times"
                      severity="warning"
                      [outlined]="true"
                      size="small"
                      (onClick)="cancelBooking(booking)"
                    />
                  }
                  @if (!booking.review_id) {
                    <p-button
                      label="✨ Agregar Reseña"
                      icon="pi pi-star-fill"
                      severity="success"
                      size="small"
                      (onClick)="toggleReviewForm(booking.id)"
                      styleClass="add-review-btn"
                    />
                  }
                  @if (booking.review_id) {
                    <p-tag
                      value="Reseña enviada"
                      severity="success"
                      icon="pi pi-check-circle"
                    />
                  }
                  <p-button
                    label="Eliminar"
                    icon="pi pi-trash"
                    severity="danger"
                    [outlined]="true"
                    size="small"
                    (onClick)="deleteBooking(booking)"
                  />
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  }
</div>

<p-confirmDialog />
